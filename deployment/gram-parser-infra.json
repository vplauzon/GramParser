{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
    },
    "variables": {
        "Unique ID": "[uniqueString(concat(resourceGroup().id, 'kusto-x'))]",
        "Suffix": "[concat('gram-parser-', variables('Unique ID'))]",
        "App Insights": "[concat('app-monitor-', variables('Suffix'))]",
        "Log Analytics": "[concat('infra-monitor-', variables('Suffix'))]",
        "App Plan": "[concat('app-plan-', variables('Suffix'))]",
        "Apps Config": [
            {
                "name": "[concat('workbench-dev-', variables('Suffix'))]",
                "targetEnv": "dev",
                "containerImage": "vplauzon/gram-parser-workbench:dev",
                "alwaysOn": true
            },
            {
                "name": "[concat('workbench-staging-', variables('Suffix'))]",
                "targetEnv": "staging",
                "containerImage": "vplauzon/gram-parser-workbench:staging",
                "alwaysOn": true
            },
            {
                "name": "[concat('workbench-', variables('Suffix'))]",
                "targetEnv": "prod",
                "containerImage": "vplauzon/gram-parser-workbench:prod",
                "alwaysOn": true
            }
        ],
        "Front Door" :"[concat('front-door-', variables('Suffix'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Insights/components",
            "name": "[variables('App Insights')]",
            "apiVersion": "2015-05-01",
            "location": "[resourceGroup().location]",
            "tags": {
            },
            "kind": "web",
            "properties": {
                "Application_Type": "web"
            },
            "dependsOn": [
            ]
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[variables('Log Analytics')]",
            "apiVersion": "2015-11-01-preview",
            "location": "[resourceGroup().location]",
            "properties": {
                "sku": {
                    "name": "PerGB2018"
                }
            },
            "dependsOn": [
            ]
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2018-02-01",
            "name": "[variables('App Plan')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [],
            "sku": {
                "name": "B1",
                "tier": "Basic",
                "size": "B1",
                "family": "B",
                "capacity": 1
            },
            "kind": "linux",
            "properties": {
                "perSiteScaling": false,
                "maximumElasticWorkerCount": 1,
                "isSpot": false,
                "reserved": true,
                "isXenon": false,
                "hyperV": false,
                "targetWorkerCount": 0,
                "targetWorkerSizeId": 0
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2019-08-01",
            "copy": {
                "name": "app-loop",
                "count": "[length(variables('Apps Config'))]",
                "mode": "parallel"
            },
            "name": "[variables('Apps Config')[copyIndex()].name]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('App Plan'))]"
            ],
            "tags": {
                "targetEnv": "[variables('Apps Config')[copyIndex()].targetEnv]"
            },
            "kind": "app,linux,container",
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('App Plan'))]",
                "siteConfig": {
                    "linuxFxVersion": "[concat('DOCKER|', variables('Apps Config')[copyIndex()].containerImage)]"
                },
                "clientAffinityEnabled": false
            },
            "resources": [
                {
                    "type": "config",
                    "apiVersion": "2018-11-01",
                    "name": "web",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', variables('Apps Config')[copyIndex()].name)]"
                    ],
                    "properties": {
                        "alwaysOn": "[variables('Apps Config')[copyIndex()].alwaysOn]",
                        "ftpsState": "Disabled"
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', variables('Apps Config')[copyIndex()].name)]"
                    ],
                    "tags": {
                    },
                    "properties": {
                        "WORKBENCH_ENVIRONMENT": "[variables('Apps Config')[copyIndex()].targetEnv]",
                        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('microsoft.insights/components/', variables('App Insights'))).InstrumentationKey]",
                        "ApplicationInsightsAgent_EXTENSION_VERSION": "~2",
                        "XDT_MicrosoftApplicationInsights_Mode": "recommended",
                        "APPINSIGHTS_PROFILERFEATURE_VERSION": "1.0.0",
                        "DiagnosticServices_EXTENSION_VERSION": "~3",
                        "APPINSIGHTS_SNAPSHOTFEATURE_VERSION": "1.0.0",
                        "SnapshotDebugger_EXTENSION_VERSION": "~1",
                        "InstrumentationEngine_EXTENSION_VERSION": "~1",
                        "XDT_MicrosoftApplicationInsights_BaseExtensions": "disabled"
                    }
                }
            ]
        }
        // ,
        // {
        //     "apiVersion": "2019-04-01",
        //     "type": "Microsoft.Network/frontDoors",
        //     "name": "[variables('Front Door')]",
        //     "location": "[resourceGroup().location]",
        //     "properties": {
        //         "routingRules": [
        //             {
        //                 "name": "routingRule1",
        //                 "properties": {
        //                     "frontendEndpoints": [
        //                         {
        //                             "id": "[resourceId('Microsoft.Network/frontDoors/frontendEndpoints', parameters('frontDoorName'), 'frontendEndpoint1')]"
        //                         }
        //                     ],
        //                     "acceptedProtocols": [
        //                         "Http",
        //                         "Https"
        //                     ],
        //                     "patternsToMatch": [
        //                         "/*"
        //                     ],
        //                     "routeConfiguration": {
        //                         "@odata.type": "#Microsoft.Azure.FrontDoor.Models.FrontdoorForwardingConfiguration",
        //                         "forwardingProtocol": "MatchRequest",
        //                         "backendPool": {
        //                             "id": "[resourceId('Microsoft.Network/frontDoors/backendPools', parameters('frontDoorName'), 'backendPool1')]"
        //                         }
        //                     },
        //                     "enabledState": "Enabled"
        //                 }
        //             },
        //             {
        //                 "name": "routingRule2",
        //                 "properties": {
        //                     "frontendEndpoints": [
        //                         {
        //                             "id": "[resourceId('Microsoft.Network/frontDoors/frontendEndpoints', parameters('frontDoorName'), 'frontendEndpoint2')]"
        //                         }
        //                     ],
        //                     "acceptedProtocols": [
        //                         "Http",
        //                         "Https"
        //                     ],
        //                     "patternsToMatch": [
        //                         "/*"
        //                     ],
        //                     "routeConfiguration": {
        //                         "@odata.type": "#Microsoft.Azure.FrontDoor.Models.FrontdoorForwardingConfiguration",
        //                         "forwardingProtocol": "MatchRequest",
        //                         "backendPool": {
        //                             "id": "[resourceId('Microsoft.Network/frontDoors/backendPools', parameters('frontDoorName'), 'backendPool1')]"
        //                         }
        //                     },
        //                     "enabledState": "Enabled"
        //                 }
        //             }
        //         ],
        //         "healthProbeSettings": [
        //             {
        //                 "name": "healthProbeSettings1",
        //                 "properties": {
        //                     "path": "/",
        //                     "protocol": "Http",
        //                     "intervalInSeconds": 120
        //                 }
        //             }
        //         ],
        //         "loadBalancingSettings": [
        //             {
        //                 "name": "loadBalancingSettings1",
        //                 "properties": {
        //                     "sampleSize": 4,
        //                     "successfulSamplesRequired": 2
        //                 }
        //             }
        //         ],
        //         "backendPools": [
        //             {
        //                 "name": "backendPool1",
        //                 "properties": {
        //                     "backends": [
        //                         {
        //                             "address": "[parameters('backendAddress')]",
        //                             "httpPort": 80,
        //                             "httpsPort": 443,
        //                             "weight": 50,
        //                             "priority": 1,
        //                             "enabledState": "Enabled"
        //                         }
        //                     ],
        //                     "loadBalancingSettings": {
        //                         "id": "[resourceId('Microsoft.Network/frontDoors/loadBalancingSettings', parameters('frontDoorName'), 'loadBalancingSettings1')]"
        //                     },
        //                     "healthProbeSettings": {
        //                         "id": "[resourceId('Microsoft.Network/frontDoors/healthProbeSettings', parameters('frontDoorName'), 'healthProbeSettings1')]"
        //                     }
        //                 }
        //             }
        //         ],
        //         "frontendEndpoints": [
        //             {
        //                 "name": "frontendEndpoint1",
        //                 "properties": {
        //                     "hostName": "[concat(parameters('frontDoorName'), '.azurefd.net')]",
        //                     "sessionAffinityEnabledState": "Disabled",
        //                     "sessionAffinityTtlSeconds": 0
        //                 }
        //             },
        //             {
        //                 "name": "frontendEndpoint2",
        //                 "properties": {
        //                     "hostName": "[parameters('customDomainName')]",
        //                     "sessionAffinityEnabledState": "Disabled",
        //                     "sessionAffinityTtlSeconds": 0
        //                 }
        //             }
        //         ],
        //         "enabledState": "Enabled"
        //     }
        // }
    ],
    "outputs": {
        "q":{
            "type": "string",
            "value":"[reference(resourceId('Microsoft.Web/sites', variables('Apps Config')[0].name), '2019-08-01').hostNames[0]]"
        }
    }
}