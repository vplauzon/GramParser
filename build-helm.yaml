pool:
  vmImage: 'Ubuntu 16.04'

variables:
  chart-path: deployment/helm-chart/ParserAsServiceApi
  image-name:  vplauzon/pas-api
  app-version-txt-path:  deployment/ApiVersion.txt
  app-version-cs-path:  PasWebApi/ApiVersion.cs
steps:
- task: PythonScript@0
  displayName: 'Manage Version'
  inputs:
    scriptPath: 'deployment/manage-version.py'
    arguments: '$(app-version-txt-path) $(app-version-cs-path) $(Build.BuildId) $(Build.ArtifactStagingDirectory)/FullVersion.txt'

- task: DotNetCoreCLI@2
  displayName: 'Test'
  inputs:
    command:  test
    projects:  PasLibTest

- task: DotNetCoreCLI@2
  displayName: 'Build an image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'vplauzon-docker-hub'
    imageName: '$(image-name):$(full-version)'
    includeLatestTag: true

- task: Docker@1
  displayName: 'Push an image'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'vplauzon-docker-hub'
    command: 'Push an image'
    imageName: '$(image-name):$(full-version)'

- task: HelmInstaller@0
  displayName: 'Install Helm 2.11.0'
  inputs:
    helmVersion: 2.11.0

- task: HelmDeploy@0
  displayName: 'Helm package'
  inputs:
    command: package
    chartPath: '$(chart-path)'
    chartVersion: '$(full-version)'

- task: CopyFiles@2
  displayName: 'Copy Release scripts'
  inputs:
    SourceFolder: deployment
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'